---
title: "7-ORFcalling Dataset Collapsing"
author: "Kathryn Walters"
date: "2023-05-11"
output: html_document
---
```{r libraries, warning=FALSE, message=FALSE, echo=FALSE}
library(Biostrings)
library(rlist)
library(ggVennDiagram)
```


```{r load data, message=FALSE, warning=FALSE, echo=FALSE}
ribocode <- read_csv(here("ORFcalling", "Expression Filtered ORFcalling", "RiboCodeFiltered.csv"))

ORFquant <- read_csv(here("ORFcalling", "Expression Filtered ORFcalling", "ORFquant_Filtered.csv"))

```


#my goal for this RMD is to combine these two into one dataset. I will use gffcompare to create a baseline I think. 

```{r gtf combined, warning=FALSE, message=FALSE}

#this one has ORFquant as the reference file.
gffCompare_ALL <- read_tsv(here("accessories", "gffCompare", "tryRef.Ribocode_renamed_final_GNchanged2.gtf.tmap"))

gffCompare_ALL2 <- read_tsv(here("accessories", "gffCompare", "tryRef_OQ.ORFquant_CDS_final_GNchanged2.gtf.tmap"))
IDswitch <- read_csv(here("accessories", "ORFquant_IDswitchResource.csv"))


#let me approach this in a different way..
gffCompare1 <- gffCompare_ALL[,c(3,4)] %>% filter(class_code == "=") %>% dplyr::select(qry_gene_id) %>% unique()

gffCompare2 <- gffCompare_ALL2[,c(1,3)] %>% filter(class_code == "=") %>% dplyr::select(ref_gene_id) %>% unique()

differences <- setdiff(gffCompare2$ref_gene_id, gffCompare1$qry_gene_id)
differences

differences1 <- setdiff(gffCompare1$qry_gene_id, gffCompare2$ref_gene_id)
differences1

#So these 6 are ones that are sometimes marked = but not in both datasets. Therefore, we are going to keep them as separate. We are going to change these class codes in the necessary datasets. 
ORFquantProblems <- c("ENST00000255380.8_780_2549", "ENST00000617528.1_27_404", "ENST00000409556.5_366_4328", "ENST00000281317.9_1217_2464", "ENST00000281830.3_611_994", "ENST00000619474.4_991_1425")

gffCompare_ALL2 <- gffCompare_ALL2 %>% dplyr::mutate(class_codeII = case_when(qry_gene_id %in% ORFquantProblems ~ "c", .default = class_code))

#Now let's try to make one dataframe..

ribocode <- left_join(ribocode, gffCompare_ALL, by = c("ORF_ID" = "qry_gene_id"))

ribocode <- ribocode %>% mutate(keepColumn = case_when(class_code == "=" ~ "Both", .default = "Ribocode"))



gffCompare_ALL2 <- left_join(gffCompare_ALL2, IDswitch, by = c("qry_gene_id" = "ORF_ID_transcript"))

ORFquant <- left_join(ORFquant, gffCompare_ALL2, by = c("ORF_ID" = "ORF_ID_gene"))

ORFquant <- ORFquant %>% mutate(keepColumn = case_when(class_codeII == "=" ~ "Both", .default = "ORFquant"))


OQ1 <- ORFquant[,c(1,2,3,4,17,18)]
RC1 <- ribocode[,c(1,2,3,4,7,16)]

colnames(OQ1) <- c("ORF_ID", "AAseq", "ORF_type", "gene_id", "class_code", "keepColumn")
colnames(RC1) <- c("ORF_ID", "AAseq", "ORF_type", "gene_id", "class_code", "keepColumn")

final_nuORFs <- rbind(RC1, OQ1 %>% filter(keepColumn == "ORFquant"))

final_nuORFs %>% pull(class_code) %>% table()


#write_csv(final_nuORFs, here("output", "final_collapsedORFsList.csv"))

ribocode <- read_csv(here("ORFcalling", "Expression Filtered ORFcalling", "RiboCodeFiltered.csv"))

ORFquant <- read_csv(here("ORFcalling", "Expression Filtered ORFcalling", "ORFquant_Filtered.csv"))

ribocode$program <- "Ribocode"
ORFquant$program <- "ORFquant"

colnames(ORFquant) <- c("ORF_ID", "AAseq", "ORF_type", "gene_id", "program")

ALLORFs <- rbind(ribocode, ORFquant)

#write_csv(ALLORFs, here("output", "GeneCollapsedORFs_AllPrograms.csv"))

```

